<!DOCTYPE html>
<html lang="fr" class="">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Prime Pro+ Budget | Suite V2</title>

  <link rel="icon" type="image/png" href="https://i.ibb.co/ZzxjZCWW/6b98d931ff0e.png">
  <link rel="apple-touch-icon" href="https://i.ibb.co/ZzxjZCWW/6b98d931ff0e.png">
  <meta name="theme-color" content="#030304" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet">

  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root {
      /* Core Palette from Prime Pro+ */
      --bg-deep: #030304;
      --bg-surface: #0a0a0c;
      --primary: #D4AF37;
      --primary-dim: rgba(212, 175, 55, 0.1);
      --primary-glow: rgba(212, 175, 55, 0.4);

      /* Text */
      --text-main: #ffffff;
      --text-muted: #888899;

      /* Glassmorphism */
      --glass-bg: rgba(20, 20, 25, 0.6);
      --glass-border: 1px solid rgba(255, 255, 255, 0.08);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);

      /* Functional */
      --success: #10B981;
      --danger: #F43F5E;
      --info: #3B82F6;

      --sidebar-width: 280px;
      --ease-out: cubic-bezier(0.22, 1, 0.36, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      outline: none;
    }

    body {
      background-color: var(--bg-deep);
      color: var(--text-main);
      font-family: 'Outfit', sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(212, 175, 55, 0.05) 0%, transparent 40%),
        radial-gradient(circle at 90% 80%, rgba(100, 100, 255, 0.05) 0%, transparent 40%);
    }

    /* Ambient Noise */
    body::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 999;
      opacity: 0.4;
    }

    /* Common Components */
    .glass-panel {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      backdrop-filter: blur(10px);
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    /* Button Overrides */
    .btn,
    button {
      font-family: 'Outfit', sans-serif;
    }

    .btn-primary {
      background: var(--primary);
      color: #000;
      font-weight: 700;
      padding: 10px 20px;
      border-radius: 50px;
      transition: all 0.2s;
      box-shadow: 0 5px 15px rgba(212, 175, 55, 0.2);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(212, 175, 55, 0.4);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      padding: 8px 16px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: 0.2s;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .btn-danger {
      background: rgba(244, 63, 94, 0.1);
      color: var(--danger);
      border: 1px solid rgba(244, 63, 94, 0.2);
    }

    /* Inputs */
    input,
    select,
    textarea {
      background: rgba(20, 20, 20, 0.5) !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
      color: #fff !important;
      border-radius: 10px !important;
      padding: 10px 14px !important;
      accent-color: var(--primary);
      /* Custom Dropdown Arrow */
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    select {
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 14px center;
      background-size: 16px;
      padding-right: 40px !important;
    }

    /* Force dark theme on options */
    select option {
      background-color: #0a0a0c;
      color: white;
      padding: 12px;
    }

    /* Fix Calendar Icon Visibility */
    ::-webkit-calendar-picker-indicator {
      filter: invert(1);
      opacity: 0.6;
      cursor: pointer;
      transition: 0.2s;
    }

    ::-webkit-calendar-picker-indicator:hover {
      opacity: 1;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: rgba(10, 10, 12, 0.7);
      backdrop-filter: blur(20px);
      border-right: var(--glass-border);
      padding: 30px;
      display: flex;
      flex-direction: column;
      z-index: 100;
    }

    .nav-btn {
      width: 100%;
      background: transparent;
      border: none;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      color: var(--text-muted);
      font-size: 0.95rem;
      font-weight: 500;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s var(--ease-out);
      position: relative;
    }

    .nav-btn:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.03);
      transform: translateX(4px);
    }

    .nav-btn.active {
      color: #fff;
      background: var(--primary-dim);
      border: 1px solid rgba(212, 175, 55, 0.2);
    }

    .nav-btn.active::before {
      content: '';
      position: absolute;
      left: -30px;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 16px;
      background: var(--primary);
      border-radius: 0 4px 4px 0;
    }

    .nav-btn ion-icon,
    .nav-btn i {
      font-size: 1.1rem;
      color: #666;
      transition: 0.3s;
    }

    .nav-btn.active ion-icon,
    .nav-btn.active i {
      color: var(--primary);
      filter: drop-shadow(0 0 8px var(--primary-glow));
    }

    /* Modal Overlay */
    .modal-overlay {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
    }

    /* Custom Select */
    .custom-select-trigger {
      background: rgba(20, 20, 20, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: 0.2s;
    }

    .custom-select-trigger:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .custom-options {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background: #0a0a0c;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      margin-top: 5px;
      max-height: 250px;
      overflow-y: auto;
      z-index: 50;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .custom-option {
      padding: 12px 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: 0.2s;
      border-bottom: 1px solid rgba(255, 255, 255, 0.02);
    }

    .custom-option:hover {
      background: rgba(255, 255, 255, 0.05);
      padding-left: 18px;
    }

    .custom-option.selected {
      color: var(--primary);
      background: rgba(212, 175, 55, 0.05);
    }
  </style>
</head>

<body>

  <div id="root" style="width:100%; height:100%;"></div>

  <script>
    /* ========== AUTH LOGIC (Original Restoration) ========== */
    const GOOGLE = {
      CLIENT_ID: "625395489880-fjlv00lsbaa4hn9p6e7ekmnof98fqfqc.apps.googleusercontent.com",
      SCOPES: "https://www.googleapis.com/auth/drive.appdata openid email profile"
    };
    let accessToken = null, tokenClient = null, refreshTimer = null, accessTokenExpiry = 0;
    function scheduleSilentRefresh(expiresInSec = 3600) {
      if (refreshTimer) clearTimeout(refreshTimer);
      const delayMs = Math.max((expiresInSec - 120), 30) * 1000;
      refreshTimer = setTimeout(() => { if (tokenClient) tokenClient.requestAccessToken({ prompt: "" }); }, delayMs);
    }
    function initGoogleAuth() {
      if (!window.google || !google.accounts || !google.accounts.oauth2) { setTimeout(initGoogleAuth, 200); return; }
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE.CLIENT_ID, scope: GOOGLE.SCOPES, prompt: "",
        callback: (resp) => {
          if (resp.error) {
            if (resp.error === 'interaction_required' || resp.error === 'consent_required') signOutGoogle();
            return;
          }
          accessToken = resp.access_token;
          const expires = Number(resp.expires_in || 3600);
          accessTokenExpiry = Date.now() + expires * 1000;
          localStorage.setItem("onyx_google_authed", "1");
          window.dispatchEvent(new Event("ONYX_SIGNED_IN"));
          scheduleSilentRefresh(expires);
        }
      });
      if (localStorage.getItem("onyx_google_authed") === "1") {
        try { tokenClient.requestAccessToken({ prompt: "" }); } catch (e) { localStorage.removeItem("onyx_google_authed"); }
      }
      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible" && accessToken) {
          if (accessTokenExpiry - Date.now() < 120 * 1000) tokenClient?.requestAccessToken({ prompt: "" });
        }
      });
    }
    function signInWithGoogle() { tokenClient?.requestAccessToken({ prompt: "consent" }); }
    function signOutGoogle() {
      try { if (accessToken && window.google) google.accounts.oauth2.revoke(accessToken, () => { }); } catch (e) { }
      accessToken = null; accessTokenExpiry = 0; if (refreshTimer) clearTimeout(refreshTimer);
      localStorage.removeItem("onyx_google_authed");
      window.dispatchEvent(new Event("ONYX_SIGNED_OUT"));
    }
    window.signInWithGoogle = signInWithGoogle;
    window.signOutGoogle = signOutGoogle;
    window.addEventListener("load", () => initGoogleAuth());

    // Drive API (Simulated if running on wrong origin, but real code present)
    async function driveRequest(url, opts = {}) {
      if (!accessToken) throw new Error("Non authentifié");
      const headers = Object.assign({}, opts.headers || {}, { Authorization: `Bearer ${accessToken}` });
      const res = await fetch(url, { ...opts, headers });
      if (!res.ok) throw new Error(await res.text());
      return res;
    }
    async function ensureAppDataFileId() {
      const listRes = await driveRequest("https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&fields=files(id,name)&q=name%20%3D%20%27onyx_transactions.json%27");
      const data = await listRes.json();
      if (data.files && data.files.length) return data.files[0].id;
      const boundary = "-------314159265358979323846", delimiter = `--${boundary}\r\n`, closeDelim = `--${boundary}--`;
      const metadata = { name: "onyx_transactions.json", parents: ["appDataFolder"] };
      const body = delimiter + "Content-Type: application/json; charset=UTF-8\r\n\r\n" + JSON.stringify(metadata) + "\r\n" + delimiter + "Content-Type: application/json; charset=UTF-8\r\n\r\n" + "[]\r\n" + closeDelim;
      const createRes = await driveRequest("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id", { method: "POST", headers: { "Content-Type": `multipart/related; boundary=${boundary}` }, body });
      const created = await createRes.json(); return created.id;
    }
    async function loadTransactionsFromDrive() {
      const fileId = await ensureAppDataFileId();
      const res = await driveRequest(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`);
      return await res.json();
    }
    async function saveTransactionsToDrive(transactions) {
      const fileId = await ensureAppDataFileId();
      await driveRequest(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, { method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify(transactions) });
    }
  </script>

  <script type="text/babel">
    /* ==================== LOGIQUE REACT & HELPERS ==================== */
    const { useState, useEffect, useRef, useMemo } = React;
    const Lucide = (props) => { useEffect(() => { if (window.lucide) window.lucide.createIcons() }, [props.icon]); return <i data-lucide={props.icon} className={props.className}></i> };

    /* --- Constants & Setup --- */
    const CATEGORIES = [
      { icon: "wallet-outline", name: "Revenus", color: "#10b981" },         // Emerald
      { icon: "card-outline", name: "Crédit", color: "#607d8b" },            // Blue Grey
      { icon: "cart-outline", name: "Alimentation", color: "#3b82f6" }, // Blue
      { icon: "restaurant-outline", name: "Restaurants", color: "#f59e0b" },     // Amber
      { icon: "beer-outline", name: "Cafés / Bars", color: "#ec4899" },      // Pink
      { icon: "home-outline", name: "Logement", color: "#8b5cf6" },           // Violet
      { icon: "flash-outline", name: "Énergie / Gaz", color: "#eab308" },     // Yellow
      { icon: "water-outline", name: "Eau", color: "#06b6d4" },             // Cyan
      { icon: "wifi-outline", name: "Internet / Télécom", color: "#6366f1" }, // Indigo
      { icon: "call-outline", name: "Téléphone", color: "#d946ef" },         // Fuchsia
      { icon: "car-sport-outline", name: "Voiture", color: "#ef4444" },             // Red
      { icon: "bus-outline", name: "Transports", color: "#14b8a6" },          // Teal
      { icon: "bag-handle-outline", name: "Shopping", color: "#f43f5e" },   // Rose
      { icon: "gift-outline", name: "Cadeaux", color: "#a855f7" },            // Purple
      { icon: "document-text-outline", name: "Impôts", color: "#64748b" },         // Slate
      { icon: "medkit-outline", name: "Santé", color: "#84cc16" },       // Lime
      { icon: "briefcase-outline", name: "Travail", color: "#0f766e" },       // Dark Teal
      { icon: "card-outline", name: "Abonnements", color: "#3730a3" },          // Dark Indigo
      { icon: "game-controller-outline", name: "Loisirs", color: "#f97316" },           // Orange
      { icon: "sparkles-outline", name: "Bonus", color: "#ffd700" },              // Gold
      { icon: "leaf-outline", name: "Épargne", color: "#22c55e" },      // Green
      { icon: "thunderstorm-outline", name: "Imprévus", color: "#991b1b" },            // Dark Red
      { icon: "ellipsis-horizontal-circle-outline", name: "Autre", color: "#9ca3af" }              // Gray
    ];

    const formatAmount = n => Number(n).toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' });
    const formatDate = d => new Date(d).toLocaleDateString("fr-FR", { day: "2-digit", month: "short" });
    const sum = (arr, fn) => arr.reduce((a, c) => a + fn(c), 0);
    const randomId = () => Math.random().toString(36).slice(2, 10);
    const normalizeString = str => (str || "").toLowerCase().trim();
    const sortTransactions = arr => { if (!Array.isArray(arr)) return []; return [...arr].sort((a, b) => new Date(b.date) - new Date(a.date)); }

    /* --- Year-Month Key helpers --- */
    function monthKeyFromDate(d) { const dt = new Date(d); return `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, '0')}`; }
    function formatMonthLabel(key) { const [y, m] = key.split('-').map(n => +n); const dt = new Date(y, m - 1, 1); return dt.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }) }
    function setDateToMonth(dateStr, y, m) {
      const d = new Date(dateStr);
      d.setFullYear(y);
      d.setMonth(m - 1);
      return d.toISOString().split('T')[0];
    }
    function getMonthsWithData(transactions) {
      const map = {};
      transactions.forEach(t => {
        const key = monthKeyFromDate(t.date);
        if (!map[key]) map[key] = { key, label: formatMonthLabel(key), count: 0, totalIn: 0, totalOut: 0 };
        map[key].count++;
        if (t.type === 'income') map[key].totalIn += +t.amount;
        else map[key].totalOut += +t.amount;
      });
      return Object.values(map).sort((a, b) => b.key.localeCompare(a.key));
    }

    /* --- Components --- */

    // Custom Select Component for Categories
    function CustomSelect({ options, value, onChange, name }) {
      const [isOpen, setIsOpen] = useState(false);
      const ref = useRef(null);

      const selectedOption = options.find(o => o.name === value) || options[0];

      // Close on click outside
      useEffect(() => {
        function handleClickOutside(event) {
          if (ref.current && !ref.current.contains(event.target)) {
            setIsOpen(false);
          }
        }
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
      }, [ref]);

      return (
        <div className="relative" ref={ref}>
          {/* Hidden input for FormData compatibility */}
          <input type="hidden" name={name} value={selectedOption.name} />

          <div
            className="custom-select-trigger"
            onClick={() => setIsOpen(!isOpen)}
          >
            <div className="flex items-center gap-3">
              <ion-icon name={selectedOption.icon} style={{ color: selectedOption.color, fontSize: '1.2rem' }}></ion-icon>
              <span className="font-medium text-white">{selectedOption.name}</span>
            </div>
            <ion-icon name="chevron-down-outline" style={{ transform: isOpen ? 'rotate(180deg)' : 'rotate(0deg)', transition: '0.2s', color: '#666' }}></ion-icon>
          </div>

          {isOpen && (
            <div className="custom-options">
              {options.map(opt => (
                <div
                  key={opt.name}
                  className={`custom-option ${opt.name === value ? 'selected' : ''}`}
                  onClick={() => {
                    onChange(opt.name);
                    setIsOpen(false);
                  }}
                >
                  <ion-icon name={opt.icon} style={{ color: opt.color, fontSize: '1.2rem' }}></ion-icon>
                  <span className={opt.name === value ? 'font-bold' : 'text-gray-300'}>{opt.name}</span>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    function ChartComponent({ transactions, monthKey }) {
      const ref = useRef();

      useEffect(() => {
        if (!ref.current) return;
        const ctx = ref.current.getContext("2d");
        if (window.myChart) window.myChart.destroy();

        // 1. Determine days in month
        const [y, m] = monthKey.split('-').map(Number);
        const daysInMonth = new Date(y, m, 0).getDate();

        // Calculate total income for the month for scale max
        const totalIncome = transactions
          .filter(t => t.type === 'income')
          .reduce((sum, t) => sum + Number(t.amount), 0);

        // Build daily data
        const labels = [];
        const data = [];
        let currentBalance = 0;

        for (let d = 1; d <= daysInMonth; d++) {
          const dateStr = `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
          const dayLabel = new Date(dateStr).toLocaleDateString("fr-FR", { day: "2-digit", month: "short" });
          labels.push(dayLabel);

          // Find transactions for this day using Local Time comparison
          const dayTxs = transactions.filter(t => {
            const tDate = new Date(t.date);
            return tDate.getFullYear() === y && (tDate.getMonth() + 1) === m && tDate.getDate() === d;
          });

          dayTxs.forEach(t => {
            currentBalance += (t.type === "income" ? +t.amount : -t.amount);
          });
          data.push(currentBalance);
        }

        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, "rgba(212, 175, 55, 0.4)");
        gradient.addColorStop(1, "rgba(212, 175, 55, 0.0)");

        window.myChart = new window.Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [{
              label: "Solde",
              data: data,
              borderColor: "#D4AF37",
              backgroundColor: gradient,
              borderWidth: 2,
              fill: true,
              tension: 0.4,
              pointRadius: 0,
              pointHoverRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: {
                grid: { display: false },
                ticks: {
                  color: "#888",
                  autoSkip: false,
                  maxRotation: 45,
                  minRotation: 0
                }
              },
              y: {
                grid: { color: "rgba(255,255,255,0.05)" },
                ticks: { color: "#888" },
                suggestedMax: totalIncome > 0 ? totalIncome : undefined // Set max to income if available
              }
            }
          }
        });
        return () => { if (window.myChart) window.myChart.destroy() }
      }, [transactions, monthKey]);

      return <div className="w-full h-64"><canvas ref={ref}></canvas></div>
    }

    function DoughnutChart({ data, labels, colors, options }) {
      const ref = useRef();
      useEffect(() => {
        if (!ref.current) return;
        const ctx = ref.current.getContext("2d");
        if (window.doughnutChart) window.doughnutChart.destroy();

        window.doughnutChart = new window.Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: colors,
              borderColor: '#0a0a0c',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            ...options
          }
        });
        return () => { if (window.doughnutChart) window.doughnutChart.destroy() }
      }, [data, options]);

      return <div className="w-full h-64"><canvas ref={ref}></canvas></div>
    }

    function Sidebar({ view, setView, user }) {
      return (
        <aside className="sidebar h-full hidden md:flex">
          <div className="flex items-center gap-4 mb-10 pb-5 border-b border-white/10">
            <img src="https://i.ibb.co/ZzxjZCWW/6b98d931ff0e.png" className="w-10 h-10 rounded-xl" style={{ border: '1px solid var(--primary)', boxShadow: '0 0 15px var(--primary-glow)' }} />
            <h1 className="font-bold text-lg" style={{ background: 'linear-gradient(135deg, #fff, #aaa)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>Prime Pro+ Budget</h1>
          </div>

          {user ? (
            <div className="flex items-center gap-3 mb-8 p-3 rounded-xl bg-white/5 border border-white/5">
              <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-yellow-600 to-white flex items-center justify-center text-black font-bold">
                {user.email[0].toUpperCase()}
              </div>
              <div className="overflow-hidden">
                <div className="text-sm font-semibold truncate text-white">{user.email}</div>
                <div className="text-xs text-[var(--success)] flex items-center gap-1"><ion-icon name="cloud-done"></ion-icon> Cloud Sync</div>
              </div>
            </div>
          ) : (
            <button onClick={() => window.signInWithGoogle()} className="mb-8 w-full btn-secondary text-sm flex items-center justify-center gap-2">
              <ion-icon name="logo-google"></ion-icon> Connexion Cloud
            </button>
          )}

          <nav className="space-y-2">
            <h3 className="text-xs font-bold text-[var(--text-muted)] uppercase tracking-widest pl-2 mb-2">Principal</h3>
            <button className={`nav-btn ${view === 'dashboard' ? 'active' : ''}`} onClick={() => setView('dashboard')}>
              <ion-icon name="grid-outline"></ion-icon> Tableau de Bord
            </button>
            <button className={`nav-btn ${view === 'transactions' ? 'active' : ''}`} onClick={() => setView('transactions')}>
              <ion-icon name="swap-horizontal-outline"></ion-icon> Transactions
            </button>

            <h3 className="text-xs font-bold text-[var(--text-muted)] uppercase tracking-widest pl-2 mt-6 mb-2">Gestion</h3>
            <button className={`nav-btn ${view === 'stats' ? 'active' : ''}`} onClick={() => setView('stats')}>
              <ion-icon name="pie-chart-outline"></ion-icon> Statistiques
            </button>
            {user && (
              <button className="nav-btn mt-auto" onClick={() => window.signOutGoogle()}>
                <ion-icon name="log-out-outline"></ion-icon> Déconnexion
              </button>
            )}
          </nav>
        </aside>
      )
    }

    function StatCard({ label, value, icon, type }) {
      let colorClass = "text-white";
      if (type === 'primary') colorClass = "text-[var(--primary)]";
      if (type === 'success') colorClass = "text-[var(--success)]";
      if (type === 'danger') colorClass = "text-[var(--danger)]";

      return (
        <div className="glass-panel p-6 relative overflow-hidden group hover:-translate-y-1 transition duration-300">
          <div className="absolute top-4 right-4 text-3xl text-white/50"><ion-icon name={icon}></ion-icon></div>
          <div className="text-sm text-[var(--text-muted)] uppercase tracking-wider mb-2">{label}</div>
          <div className={`text-2xl font-bold ${colorClass}`}>{value}</div>
        </div>
      )
    }

    function StatsView({ transactions, monthKey }) {
      const expenses = transactions.filter(t => t.type === 'expense');
      const catTotals = {};
      expenses.forEach(t => { const cName = t.category.name; catTotals[cName] = (catTotals[cName] || 0) + Number(t.amount); });
      const labels = Object.keys(catTotals);
      const data = Object.values(catTotals);
      const colors = labels.map(l => CATEGORIES.find(c => c.name === l)?.color || '#fff');
      const sortedCats = Object.entries(catTotals).sort((a, b) => b[1] - a[1]);
      const topCat = sortedCats.length > 0 ? sortedCats[0] : null;

      return (
        <div className="space-y-6">
          <div className="text-sm text-[var(--text-muted)] mb-2">Statistiques pour {formatMonthLabel(monthKey)}</div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="glass-panel p-6">
              <h3 className="text-lg font-bold mb-4">Répartition des Dépenses</h3>
              {expenses.length ? (
                <div className="flex flex-col md:flex-row items-center gap-6">
                  <div className="w-full md:w-1/2 h-64">
                    <DoughnutChart data={data} labels={labels} colors={colors} options={{ plugins: { legend: { display: false } } }} />
                  </div>
                  <div className="w-full md:w-1/2 space-y-3 max-h-64 overflow-y-auto pr-2">
                    {labels.map((name, i) => {
                      const cat = CATEGORIES.find(c => c.name === name) || { icon: 'alert-circle', color: '#666' };
                      return (
                        <div key={name} className="flex items-center gap-3 text-sm text-gray-300">
                          <ion-icon name={cat.icon} style={{ color: cat.color, fontSize: '1.2rem' }}></ion-icon>
                          <span className="flex-1 truncate">{name}</span>
                          <span className="font-bold text-white">{formatAmount(data[i])}</span>
                        </div>
                      );
                    })}
                  </div>
                </div>
              ) : <div className="text-center text-gray-500 py-10">Aucune donnée pour ce mois</div>}
            </div>
            <div className="glass-panel p-6 flex flex-col justify-center">
              <h3 className="text-lg font-bold mb-4">Insights</h3>
              {topCat ? (
                <div className="space-y-4">
                  <div className="p-4 rounded-xl bg-white/5 border border-white/5">
                    <div className="text-xs text-[var(--text-muted)] uppercase">Top Catégorie</div>
                    <div className="text-xl font-bold text-white flex items-center gap-2 mt-1">
                      {topCat[0]}
                      <span className="text-sm font-normal text-gray-400">({formatAmount(topCat[1])})</span>
                    </div>
                  </div>
                  <div className="p-4 rounded-xl bg-white/5 border border-white/5">
                    <div className="text-xs text-[var(--text-muted)] uppercase">Moyenne / Transaction</div>
                    <div className="text-xl font-bold text-white mt-1">
                      {formatAmount(expenses.length ? sum(expenses, t => t.amount) / expenses.length : 0)}
                    </div>
                  </div>
                </div>
              ) : <div className="text-center text-gray-500">Pas assez de données</div>}
            </div>
          </div>
        </div>
      )
    }

    function DuplicateModal({ show, onClose, months, currentMonth, onDuplicate }) {
      const [targetMonth, setTargetMonth] = useState("");
      useEffect(() => {
        if (currentMonth) {
          const [y, m] = currentMonth.split('-').map(Number);
          const next = new Date(y, m, 1);
          setTargetMonth(`${next.getFullYear()}-${String(next.getMonth() + 1).padStart(2, '0')}`);
        }
      }, [currentMonth, show]);
      if (!show) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-overlay">
          <div className="glass-panel p-8 w-full max-w-md bg-[#0a0a0c]">
            <h2 className="text-xl font-bold mb-4 text-white">Dupliquer le Mois</h2>
            <p className="text-gray-400 mb-6 text-sm">Copier toutes les transactions de <b>{formatMonthLabel(currentMonth)}</b> vers :</p>
            <input type="month" className="w-full mb-6" value={targetMonth} onChange={e => setTargetMonth(e.target.value)} />
            <div className="flex gap-3">
              <button onClick={onClose} className="btn-secondary w-full">Annuler</button>
              <button onClick={() => { if (!targetMonth) return; const [ty, tm] = targetMonth.split('-').map(Number); onDuplicate(ty, tm); }} className="btn-primary w-full">Confirmer</button>
            </div>
          </div>
        </div>
      );
    }

    /* --- Main App --- */
    function App() {
      const [transactions, setTransactions] = useState([]);
      const [view, setView] = useState('dashboard');
      const [user, setUser] = useState(null);
      const [showModal, setShowModal] = useState(false);
      const [editTx, setEditTx] = useState(null);
      const [monthFilter, setMonthFilter] = useState(monthKeyFromDate(new Date()));
      const [showDupModal, setShowDupModal] = useState(false);

      // State Controlled Form for Modal
      const [formData, setFormData] = useState({ categoryName: CATEGORIES[0].name });

      useEffect(() => {
        const local = localStorage.getItem("onyx_budget_v2");
        if (local) setTransactions(JSON.parse(local));
        window.addEventListener("ONYX_SIGNED_IN", () => setUser({ email: "Connecté" }));
        window.addEventListener("ONYX_SIGNED_OUT", () => setUser(null));
        if (localStorage.getItem("onyx_google_authed") === "1") setUser({ email: "Utilisateur Cloud" });
      }, []);

      useEffect(() => { localStorage.setItem("onyx_budget_v2", JSON.stringify(transactions)); }, [transactions]);

      // When opening modal, sync state
      useEffect(() => {
        if (showModal) {
          setFormData({ categoryName: editTx ? editTx.category.name : CATEGORIES[0].name });
        }
      }, [showModal, editTx]);

      const handleSave = (tx) => {
        let next = [...transactions];
        if (editTx) next = next.map(t => t.id === tx.id ? tx : t);
        else next.push({ ...tx, id: randomId() });
        next.sort((a, b) => new Date(b.date) - new Date(a.date));
        setTransactions(next);
        setShowModal(false);
        if (window.saveTransactionsToDrive && user) window.saveTransactionsToDrive(next);
      };

      const handleDelete = (id) => {
        if (!confirm("Supprimer ?")) return;
        const next = transactions.filter(t => t.id !== id);
        setTransactions(next);
        if (window.saveTransactionsToDrive && user) window.saveTransactionsToDrive(next);
      }

      const handleExport = () => {
        const link = document.createElement('a');
        link.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(transactions, null, 2));
        link.download = "transactions.json"; link.click();
      }

      const handleImport = (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = async (evt) => {
          try {
            const json = JSON.parse(evt.target.result);
            if (Array.isArray(json)) {
              const next = sortTransactions(json);
              setTransactions(next);
              if (window.saveTransactionsToDrive && user) window.saveTransactionsToDrive(next);
              alert("Import réussi !");
            } else alert("Fichier invalide !");
          } catch { alert("Erreur import JSON"); }
        };
        reader.readAsText(file);
      }

      const handleDuplicateMonth = (targetYear, targetMonth) => {
        const toCopy = transactions.filter(t => monthKeyFromDate(t.date) === monthFilter);
        if (!toCopy.length) { alert("Rien à copier !"); return; }
        const clones = toCopy.map(t => ({ ...t, id: randomId(), date: setDateToMonth(t.date, targetYear, targetMonth) }));
        const next = sortTransactions([...transactions, ...clones]);
        setTransactions(next);
        if (window.saveTransactionsToDrive && user) window.saveTransactionsToDrive(next);
        setShowDupModal(false);
        setMonthFilter(`${targetYear}-${String(targetMonth).padStart(2, '0')}`);
        alert("Mois dupliqué avec succès !");
      };

      const handleDeleteMonth = (key) => {
        const count = transactions.filter(t => monthKeyFromDate(t.date) === key).length;
        if (count === 0) return;
        if (!confirm(`Supprimer TOUTES les ${count} transactions de ${formatMonthLabel(key)} ?`)) return;
        const next = transactions.filter(t => monthKeyFromDate(t.date) !== key);
        setTransactions(next);
        if (window.saveTransactionsToDrive && user) window.saveTransactionsToDrive(next);
        setMonthFilter(monthKeyFromDate(new Date()));
      };

      const availableMonths = getMonthsWithData(transactions);
      const optionsList = [...availableMonths];
      if (!optionsList.find(m => m.key === monthFilter)) optionsList.unshift({ key: monthFilter, label: formatMonthLabel(monthFilter) });
      optionsList.sort((a, b) => b.key.localeCompare(a.key));

      const displayedTransactions = transactions.filter(t => monthKeyFromDate(t.date) === monthFilter);
      const income = sum(displayedTransactions.filter(t => t.type === 'income'), t => +t.amount);
      const expense = sum(displayedTransactions.filter(t => t.type === 'expense'), t => +t.amount);
      const balance = income - expense;

      return (
        <div className="flex h-screen w-full text-white">
          <Sidebar view={view} setView={setView} user={user} />
          <main className="flex-1 overflow-y-auto p-8 relative">
            <header className="flex justify-between items-end mb-8">
              <div>
                <h2 className="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                  {view === 'dashboard' ? 'Tableau de Bord' : (view === 'transactions' ? 'Transactions' : 'Statistiques')}
                </h2>
                <div className="flex items-center gap-3 mt-1">
                  <p className="text-[var(--text-muted)]">Données du mois : </p>
                  <select
                    value={monthFilter}
                    onChange={(e) => setMonthFilter(e.target.value)}
                    className="bg-white/10 border-none text-white text-sm rounded-lg px-2 py-1 outline-none font-bold cursor-pointer"
                  >
                    {optionsList.map(m => (<option key={m.key} value={m.key}>{m.label}</option>))}
                  </select>
                  {displayedTransactions.length > 0 && (
                    <button onClick={() => handleDeleteMonth(monthFilter)} className="p-2 text-white/40 hover:text-[var(--danger)] transition rounded-lg hover:bg-white/5" title="Supprimer ce mois">
                      <ion-icon name="trash-outline"></ion-icon>
                    </button>
                  )}
                </div>
              </div>
              <div className="flex gap-3">
                <button onClick={() => setShowDupModal(true)} className="btn-secondary flex items-center gap-2" title="Dupliquer">
                  <ion-icon name="copy-outline"></ion-icon> Dupliquer
                </button>
                {view === 'transactions' && (
                  <>
                    <button onClick={handleExport} className="btn-secondary flex items-center gap-2"><ion-icon name="download-outline"></ion-icon></button>
                    <label className="btn-secondary flex items-center gap-2 cursor-pointer">
                      <ion-icon name="cloud-upload-outline"></ion-icon>
                      <input type="file" accept=".json" onChange={handleImport} className="hidden" />
                    </label>
                  </>
                )}
                <button onClick={() => { setEditTx(null); setShowModal(true) }} className="btn-primary flex items-center gap-2">
                  <ion-icon name="add-circle" class="text-xl md:text-2xl font-bold"></ion-icon> <span className="font-bold">Transaction</span>
                </button>
              </div>
            </header>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
              <StatCard label={`Solde (${formatMonthLabel(monthFilter)})`} value={formatAmount(balance)} icon="wallet-outline" type="primary" />
              <StatCard label="Revenus" value={formatAmount(income)} icon="trending-up-outline" type="success" />
              <StatCard label="Dépenses" value={formatAmount(expense)} icon="trending-down-outline" type="danger" />
            </div>

            {view === 'dashboard' && (
              <div className="glass-panel p-6 mb-8">
                <h3 className="text-lg font-bold mb-4">Évolution du Solde</h3>
                <ChartComponent transactions={displayedTransactions} monthKey={monthFilter} />
              </div>
            )}

            {view === 'stats' && <StatsView transactions={displayedTransactions} monthKey={monthFilter} />}

            {(view === 'dashboard' || view === 'transactions') && (
              <div className="glass-panel p-6">
                <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                  <ion-icon name="list-outline"></ion-icon> {view === 'dashboard' ? 'Dernières Transactions' : 'Toutes les Transactions'}
                </h3>
                <div className="overflow-x-auto">
                  <table className="w-full text-left text-sm text-gray-400">
                    <thead className="text-[var(--text-muted)] uppercase border-b border-white/10">
                      <tr>
                        <th className="pb-3 pl-2">Titre</th>
                        <th className="pb-3">Catégorie</th>
                        <th className="pb-3">Date</th>
                        <th className="pb-3 text-right">Montant</th>
                        <th className="pb-3">Actions</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-white/5">
                      {displayedTransactions.slice(0, view === 'dashboard' ? 5 : undefined).map(tx => (
                        <tr key={tx.id} className="group hover:bg-white/5 transition">
                          <td className="py-4 pl-2 font-medium text-white">{tx.title}</td>
                          <td className="py-4">
                            {(() => {
                              const cat = CATEGORIES.find(c => c.name === tx.category.name) || { icon: 'alert-circle-outline', color: '#666', name: tx.category.name };
                              return (
                                <span className="px-2 py-1 rounded-md bg-white/10 text-xs flex items-center gap-2 w-fit">
                                  <ion-icon name={cat.icon} style={{ color: cat.color }}></ion-icon> {cat.name}
                                </span>
                              );
                            })()}
                          </td>
                          <td className="py-4">{formatDate(tx.date)}</td>
                          <td className={`py-4 text-right font-bold ${tx.type === 'income' ? 'text-[var(--success)]' : 'text-[var(--danger)]'}`}>
                            {tx.type === 'income' ? '+' : '-'} {formatAmount(tx.amount)}
                          </td>
                          <td className="py-4">
                            <div className="flex gap-2">
                              <button onClick={() => { setEditTx(tx); setShowModal(true) }} className="p-2 hover:text-white transition"><ion-icon name="create-outline"></ion-icon></button>
                              <button onClick={() => handleDelete(tx.id)} className="p-2 hover:text-red-500 transition"><ion-icon name="trash-outline"></ion-icon></button>
                            </div>
                          </td>
                        </tr>
                      ))}
                      {displayedTransactions.length === 0 && <tr><td colSpan="5" className="text-center py-8">Aucune transaction</td></tr>}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </main>

          {showModal && (
            <div className="fixed inset-0 z-50 flex items-center justify-center modal-overlay">
              <div className="glass-panel p-8 w-full max-w-lg relative bg-[#0a0a0c]">
                <button onClick={() => setShowModal(false)} className="absolute top-4 right-4 text-2xl hover:text-red-500"><ion-icon name="close-outline"></ion-icon></button>
                <h2 className="text-2xl font-bold mb-6 text-white">{editTx ? "Modifier" : "Ajouter"}</h2>

                <form onSubmit={(e) => {
                  e.preventDefault();
                  const fd = new FormData(e.target);
                  const catName = fd.get('category');
                  const catObj = CATEGORIES.find(c => c.name === catName) || CATEGORIES[0];
                  handleSave({
                    id: editTx?.id,
                    title: fd.get('title'),
                    amount: fd.get('amount'),
                    type: fd.get('type'),
                    category: catObj,
                    date: fd.get('date') || new Date().toISOString().split('T')[0]
                  });
                }} className="space-y-4">
                  <div>
                    <label className="block text-sm text-[var(--text-muted)] mb-1">Titre</label>
                    <input name="title" required defaultValue={editTx?.title} className="w-full" placeholder="Ex: Salaire, Courses..." autoFocus />
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm text-[var(--text-muted)] mb-1">Montant</label>
                      <input name="amount" type="number" step="0.01" required defaultValue={editTx?.amount} className="w-full" placeholder="0.00" />
                    </div>
                    <div>
                      <label className="block text-sm text-[var(--text-muted)] mb-1">Type</label>
                      <select name="type" defaultValue={editTx?.type || "expense"} className="w-full text-white">
                        <option value="expense">Dépense (Sortie)</option>
                        <option value="income">Revenu (Entrée)</option>
                      </select>
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm text-[var(--text-muted)] mb-1">Catégorie</label>
                    <CustomSelect
                      name="category"
                      options={CATEGORIES}
                      value={formData.categoryName}
                      onChange={(val) => setFormData({ ...formData, categoryName: val })}
                    />
                  </div>
                  <div>
                    <label className="block text-sm text-[var(--text-muted)] mb-1">Date</label>
                    <input name="date" type="date" defaultValue={editTx?.date ? new Date(editTx.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]} className="w-full" />
                  </div>

                  <button type="submit" className="w-full btn-primary mt-4 flex justify-center items-center gap-2">
                    <ion-icon name="checkmark-circle"></ion-icon> Sauvegarder
                  </button>
                </form>
              </div>
            </div>
          )}

          <DuplicateModal
            show={showDupModal}
            onClose={() => setShowDupModal(false)}
            currentMonth={monthFilter}
            onDuplicate={handleDuplicateMonth}
          />
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>

</html>
